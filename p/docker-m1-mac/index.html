<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Yet Again, Docker macOS After using the official Docker for Mac for a while, it became clear to me that the app is not yet stable and reliable enough to be used for professional use case in the background nor user-friendly, ready-to-go like a actual desktop mac app.
I toned down the setting and limiting the CPU to 2 cores with 4/3(?)GB RAM, and I also checked the box for using the new release virtualization framework in Experimental feature."><title>Docker M1 Mac</title>
<link rel=canonical href=https://wyq977.github.io/p/docker-m1-mac/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Docker M1 Mac">
<meta property="og:description" content="Yet Again, Docker macOS After using the official Docker for Mac for a while, it became clear to me that the app is not yet stable and reliable enough to be used for professional use case in the background nor user-friendly, ready-to-go like a actual desktop mac app.
I toned down the setting and limiting the CPU to 2 cores with 4/3(?)GB RAM, and I also checked the box for using the new release virtualization framework in Experimental feature.">
<meta property="og:url" content="https://wyq977.github.io/p/docker-m1-mac/">
<meta property="og:site_name" content="My Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-01-05T10:48:47+01:00"><meta property="article:modified_time" content="2022-01-05T10:48:47+01:00">
<meta name=twitter:title content="Docker M1 Mac">
<meta name=twitter:description content="Yet Again, Docker macOS After using the official Docker for Mac for a while, it became clear to me that the app is not yet stable and reliable enough to be used for professional use case in the background nor user-friendly, ready-to-go like a actual desktop mac app.
I toned down the setting and limiting the CPU to 2 cores with 4/3(?)GB RAM, and I also checked the box for using the new release virtualization framework in Experimental feature.">
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://wyq977.github.io class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/guide/ style=background-color:#0177b8;color:#fff>
Guide
</a>
</header>
<h2 class=article-title>
<a href=/p/docker-m1-mac/>Docker M1 Mac</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 05, 2022</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h1 id=yet-again-docker-macos>Yet Again, Docker macOS</h1>
<p>After using the official Docker for Mac for a while, it became clear to me that the app is not yet stable and reliable enough to be used for professional use case in the background nor user-friendly, ready-to-go like a actual desktop mac app.</p>
<p>I toned down the setting and limiting the CPU to 2 cores with 4/3(?)GB RAM, and I also checked the box for using the new release virtualization framework in Experimental feature. However, the ram usage would still be going thr the limits and lagging, breakdown is also often seen. Eating roughly 4GB of RAM and I have seen errors where it said it used 30G but probably swap usage along with crashes&mldr;</p>
<p>As under the hook, the Docker for Mac still basically created a Linux VM, kind of like podman. The underlying performance issues might be the way the VM is regulated/managed. So, why not just create a VM and use docker cli or simply ssh to the linux instance?</p>
<p>There are a bit headaches and issues with Docker on macOS.</p>
<ol>
<li>IO has always been a really big issue, causing really slow build and even slow git for bigger project. I never tested on new build now.</li>
<li>Volume mounting.</li>
</ol>
<p>Although creating your own VM will also lead to a plate of problmes such as network device/video device/volume storage mounting. But those issues are also persistant on macOS app. After all its not linux.</p>
<h2 id=perfomance-issues>Perfomance issues</h2>
<p><a class=link href=https://www.lifeintech.com/2021/11/03/docker-performance-on-m1/ target=_blank rel=noopener>The article</a> caught my eyes as it compares docker build time on Intel/Apple Silicon Macs with different hyperviser.</p>
<p><figure>
<a href=https://www.lifeintech.com/images/posts/dockerperformanceonm101.jpg>
<img src=https://www.lifeintech.com/images/posts/dockerperformanceonm101.jpg loading=lazy alt="Test Results">
</a>
<figcaption>Test Results</figcaption>
</figure></p>
<p>The Table said it all, whatever it is, the Docker for Mac makes it hard for macOS to deliver the performance it is capable of. And that last line is the one I am interested.</p>
<h2 id=devicevolume-mounting-issue>device/volume mounting issue</h2>
<p>For me, personally, theres a need to use the volume in Docker and that volume is not one M1&rsquo;s SSD but on another network device mounted on macOS via SMB/CIFS.</p>
<p>It was slow on macOS itself and it will probably take a bigger blow with all that connection protocol added on top of that with introducing VM. So I am curious about how it went going forward.</p>
<h2 id=actual-set-up>Actual set up</h2>
<p><a class=link href=https://www.codeluge.com/post/setting-up-docker-on-macos-m1-arm64-to-use-debian-10.4-docker-engine/#configuring-mac-os-host-docker-cli-to-use-debians-docker-engine target=_blank rel=noopener>A detailed post on setting up UTM VM with Docker on macOS</a></p>
<p>First, install <a class=link href=https://mac.getutm.app/ target=_blank rel=noopener>UTM</a>, a free and open source VM tool built only for macOS.</p>
<p>A minial debian build <a class=link href=https://mac.getutm.app/gallery/debian-10-4-minimal target=_blank rel=noopener>Debian 10.4</a> were used for installing Docker, in theory, more trimming can be done to reduce the overhead on that instance.</p>
<ol>
<li>Remeber to change root user(root/password) and default user(debian/debian):</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>sudo passwd root
sudo passwd debian
</code></pre></div><ol start=2>
<li>Update and install essential: SSH</li>
</ol>
<p>Some problems with apt-get update: <a class=link href=https://stackoverflow.com/questions/68802802/repository-http-security-debian-org-debian-security-buster-updates-inrelease target=_blank rel=noopener>https://stackoverflow.com/questions/68802802/repository-http-security-debian-org-debian-security-buster-updates-inrelease</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>sudo apt-get update -y <span class=o>&amp;&amp;</span> sudo apt-get install openssl-server

<span class=c1># check</span>
sudo systemctl status ssh
</code></pre></div><p>This confirms the SSH server is running and listening on port 22. If you need more help with that, PhoenixNap has a great tutorial on <a class=link href=https://phoenixnap.com/kb/how-to-enable-ssh-on-debian target=_blank rel=noopener>How to Enable SSH on Debian</a>.</p>
<ol start=3>
<li>Install Docker on Debian 10.4 VM</li>
</ol>
<p>Follow: <a class=link href=https://phoenixnap.com/kb/how-to-install-docker-on-debian-10 target=_blank rel=noopener>https://phoenixnap.com/kb/how-to-install-docker-on-debian-10</a></p>
<p>Change amd64 to arm64</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># Step 1: Uninstall Default Docker Packages</span>
sudo apt-get purge docker lxc-docker docker-engine docker.io

<span class=c1># Step 2: Install Required Packages</span>
<span class=c1># Update the default repository with the command:</span>
sudo apt-get update

<span class=c1># Download the following dependencies:</span>

sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common

<span class=c1># Step 3: Install Docker</span>
<span class=c1># Method 1</span>

<span class=c1># 1. Download Docker’s official GPG key to verify the integrity of packages before installing:</span>
curl -fsSL https://download.docker.com/linux/debian/gpg <span class=p>|</span> sudo apt-key add -

<span class=c1># 2. Add the Docker repository to your system repository with the following command:</span>
sudo add-apt-repository <span class=s2>&#34;deb [arch=arm64] https://download.docker.com/linux/debian buster stable&#34;</span>

<span class=c1># 3. Update the apt repository:</span>
sudo apt-get update

<span class=c1># 4. Install Docker Engine – Community (the latest version of Docker) and containerd:</span>
sudo apt-get install docker-ce docker-ce-cli containerd.io

<span class=c1># 5. The service will start automatically after the installation. Check the status by typing:</span>
sudo systemctl status docker

<span class=c1># check if docker works</span>
docker -v
</code></pre></div><h2 id=config-macos-docker-cli-to-use-vms-docker-enginer>Config macos Docker CLI to use VM&rsquo;s Docker Enginer</h2>
<pre tabindex=0><code class=language-shel data-lang=shel># this should returns nothing/empty output
ssh debian@127.0.0.1 -p 22022 -N -L/tmp/docker-on-debian.sock:/var/run/docker.sock ssh://debian@127.0.0.1
# set up DOCKER_HOST location
export DOCKER_HOST=unix:///tmp/docker-on-debian.sock

</code></pre><blockquote>
<p>We’ll get “permission denied” when trying to use the Docker CLI from macOS. This is because the debian user doesn’t have permissions to use Docker without using sudo. To fix this, on the Debian VM, we’ll run the following command to add the debian user to the docker user group:</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>sudo usermod -aG docker <span class=nv>$USER</span> 
</code></pre></div><blockquote>
<p>Now the Docker CLI will connect to the Debian VM instead. We will confirm this by running docker system info | grep System from the macOS terminal to see that the operating system is Debian, not Darwin or macOS:</p>
</blockquote>
<p>Working!</p>
<pre tabindex=0><code>$ docker system info
Client:
 Context:    default
 Debug Mode: false

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 20.10.12
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Native Overlay Diff: true
  userxattr: false
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: runc io.containerd.runc.v2 io.containerd.runtime.v1.linux
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 7b11cfaabd73bb80907dd23182b9347b4245eb5d
 runc version: v1.0.2-0-g52b36a2
 init version: de40ad0
 Security Options:
  apparmor
  seccomp
   Profile: default
 Kernel Version: 4.19.0-9-arm64
 Operating System: Debian GNU/Linux 10 (buster)
 OSType: linux
 Architecture: aarch64
 CPUs: 8
 Total Memory: 1.45GiB
 Name: debian
 ID: R5BA:KFRQ:37TY:VCYD:HPVW:NTVN:2F5L:RS4S:GLNT:CXCX:6RUJ:C6U6
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false

WARNING: No swap limit support
</code></pre><h2 id=problems-with-utm>Problems with UTM</h2>
<h3 id=ui-still-freezes-from-time-to-time-when-i-tried-to-resizeconfig-the-image-thats-annoying-af>UI still freezes from time to time when I tried to resize/config the image. Thats annoying af.</h3>
<h3 id=problems-with-porting>Problems with porting:</h3>
<p>It seems to I have to keep this ssh activa without CTRL+C</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ ssh debian@127.0.0.1 -p <span class=m>22022</span> -N -L/tmp/docker-on-debian.sock:/var/run/docker.sock ssh://debian@127.0.0.1
</code></pre></div><p>After I stopped, I need to remove sock and re-do the whole thing.</p>
<p>Solution: treat the VM as remote host and modify <code>DOCKER_HOST</code>, ssh create a private key and adds it to VM.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=nb>export</span> <span class=nv>DOCKER_HOST</span><span class=o>=</span><span class=s2>&#34;ssh://debian@127.0.0.1:22022&#34;</span>
</code></pre></div><h3 id=cpu-benchmark-1000-difference-with-native-sysbench>CPU Benchmark (1000 difference with native sysbench)</h3>
<p><a class=link href=https://levelup.gitconnected.com/running-amd64-linux-on-apple-m1-with-qemu-utm-64d67cccd6f8 target=_blank rel=noopener>Another post benchmark cpu using <code>sysbench</code></a></p>
<p>With a threads=2, I got 105585 in ubuntu docker</p>
<pre tabindex=0><code>docker run -it --rm ubuntu
apt-get update &amp;&amp; apt-get install sysbench
sysbench cpu --threads=2 run
</code></pre><pre tabindex=0><code class=language-log data-lang=log>#### ubuntu docker (arm) on 1.5 GB ram Debian VM by UTM
CPU speed:
    events per second: 21115.40

#### UTM Debian 10.4 
CPU speed:
    events per second: 21082.14

#### macos native
CPU speed:
    events per second: 25912346.76

#### macos Intel Core i5 - 10210U
CPU speed:
    events per second: 8372004.44

#### ubuntu on intel (Docker 4 CPUs 8 GB RAM swap 2 GB)
# docker -v
# Docker version 20.10.11, build dea9396
CPU speed:
    events per second:  2526.18
</code></pre><p>WTF, why is VM takes such a dramatic hit, even with the right tool. I might ended up using the Sonarr/Radarr for macOS, 4.0.0 of Radarr already has osx-arm64 build, just waiting for Sonarr.</p>
<p>And yes, the QEMU used by UTM would still eat up about 2.3 GB RAM</p>
</section>
<footer class=article-footer>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/p/set-up-aria2-and-chrome-working-nicely-together/>
<div class=article-details>
<h2 class=article-title>Set up Aria2 and Chrome working nicely together</h2>
</div>
</a>
</article>
<article>
<a href=/p/x11-forwarding-on-macos/>
<div class=article-details>
<h2 class=article-title>x11 forwarding on macOS</h2>
</div>
</a>
</article>
<article>
<a href=/p/sign-with-gpg/>
<div class=article-details>
<h2 class=article-title>Sign With GPG</h2>
</div>
</a>
</article>
<article>
<a href=/p/download-qq-videos/>
<div class=article-details>
<h2 class=article-title>Download qq videos</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/p/test-for-blog-but-no-emoji-in-title/>
<div class=article-image>
<img src=/p/test-for-blog-but-no-emoji-in-title/_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_27040ddd7399aaf289c0ce70ee6592d9.jpg width=250 height=150 loading=lazy data-key data-hash="md5-RvYejqai34/Fvx0koXxEpg==">
</div>
<div class=article-details>
<h2 class=article-title>Test for blog but no emoji in title :(</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2022 My Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#perfomance-issues>Perfomance issues</a></li>
<li><a href=#devicevolume-mounting-issue>device/volume mounting issue</a></li>
<li><a href=#actual-set-up>Actual set up</a></li>
<li><a href=#config-macos-docker-cli-to-use-vms-docker-enginer>Config macos Docker CLI to use VM&rsquo;s Docker Enginer</a></li>
<li><a href=#problems-with-utm>Problems with UTM</a>
<ol>
<li><a href=#ui-still-freezes-from-time-to-time-when-i-tried-to-resizeconfig-the-image-thats-annoying-af>UI still freezes from time to time when I tried to resize/config the image. Thats annoying af.</a></li>
<li><a href=#problems-with-porting>Problems with porting:</a></li>
<li><a href=#cpu-benchmark-1000-difference-with-native-sysbench>CPU Benchmark (1000 difference with native sysbench)</a></li>
</ol>
</li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>